# Clivern Lynx - Terraform State Backend
# OPA policy thresholds scoped to Terraform-managed resources only
# Validates: lynx_user, lynx_team, lynx_project, lynx_environment, lynx_snapshot
# and restapi_object calls to Lynx API
#
# NOTE: Infrastructure-level controls (TLS, clustering, database, container
# hardening) are NOT here. Those belong in Mondoo/cnspec scanning policies
# or Helm/Docker Compose validation, not Terraform plan validation.

lynx:
  user_resources:
    # Block admin role assignment via Terraform
    block_terraform_admin_creation: true
    # Allowed roles that can be provisioned via IaC
    allowed_terraform_roles:
      - "regular"
    # Require email domain restriction on lynx_user resources
    require_email_domain_restriction: true
    allowed_email_domains:
      - "gurdipscode.com"
    # Block hardcoded passwords in lynx_user resources
    block_hardcoded_passwords: true
    # Minimum password length (if password is set)
    min_password_length: 16

  team_resources:
    # Require description on lynx_team resources
    require_team_description: true
    # Require slug naming convention
    require_slug_pattern: true
    team_slug_pattern: "^[a-z][a-z0-9-]+$"
    # Maximum members per team resource
    max_team_members: 25
    # Require at least one member
    require_minimum_members: true
    min_team_members: 1

  project_resources:
    # Require description on lynx_project resources
    require_project_description: true
    # Require slug naming convention
    require_slug_pattern: true
    project_slug_pattern: "^[a-z][a-z0-9-]+$"
    # Require team assignment (block unowned projects)
    require_team_assignment: true
    # Block projects assigned to multiple teams
    require_single_team_ownership: true

  environment_resources:
    # Require slug naming convention
    require_slug_pattern: true
    environment_slug_pattern: "^(dev|development|staging|uat|preprod|prod|production|dr)$"
    # Require project assignment
    require_project_assignment: true
    # Block creating environments in unrecognised projects
    validate_project_exists: true

  snapshot_resources:
    # Require snapshots tied to valid environments
    require_environment_reference: true
    # Require description on snapshots
    require_snapshot_description: true

  provider_config:
    # Require HTTPS on provider api_url
    require_provider_https: true
    # Block hardcoded api_key in provider block
    block_hardcoded_api_key: true
    # Minimum provider version
    min_provider_version: "0.3.0"

  general:
    # Require Terraform resource naming convention
    require_resource_name_prefix: true
    resource_name_prefix: "lynx-"
    # Block destroy actions on team and project resources
    block_team_deletion: true
    block_project_deletion: true
    # Block destroy on environment resources (state loss risk)
    block_environment_deletion: true
    # Maximum total lynx resources per module (complexity cap)
    max_resources_per_module: 50
